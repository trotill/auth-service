## О сервисе
Сервис авторизации предназначен для использования в embedded и легких серверных системах.
Сервис обеспечивает JWT авторизацию и управление пользователями, имеет возможность легкой интеграции
с бэкендом на nestjs и имеет защиту от brute force атак


В сервисе доступны 3 роли, admin, operator и guest, admin может все, если не установлена опция DENY_ADMIN_CHANGE_ADMIN

Роли ниже админа не могут блокировать пользователей, менять роль, удалять/создавать/изменять пользователей,
но могут получать список всех пользователей. Получение списка пользователей ролям ниже админа можно запретить опцией DENY_GET_USER_LIST


По умолчанию регистрация пользователей со стороны запрещена, можно включить это опцией ALLOW_USER_REGISTRATION


## Зависимости
1. nodejs 18.14.0
2. node-gyp
3. npm
4. sqlite3

## Установка/настройка сервиса
1. Скопируйте .env.example в .env
   В .env скорректируйте переменные (см. ниже описание)
2. npm install
3. публичный и приватный ключи, БД генерируются автоматически при старте
4. перед первым запуском в режиме разработки нужно сделать миграции и сиды (в прод режиме, этого делать не нужно)
   - npm run migrate
   - npm run seed

## Запуск в режиме прода
npm run start

## Запуск в режиме разработки

npm run start:dev

## Запуск в docker контейнере
1. запуск npm run docker:up
2. останов npm run docker:down

## Опции .env файла
### Порт веб сервера
LISTEN_HTTP_PORT=4499
### Путь к папке для ключей и БД
STORE_PATH=store

### Имя файла БД
DB_PATH=auth.db

### Имя БД
DB_NAME=database_development

### Пользователь БД
DB_USER=develinux

### Пароль к БД
DB_PASSWORD=cnfhjcnm

### Время жизни access токена
ACCESS_TIMEOUT=60s

### Время жизни refresh токена
REFRESH_TIMEOUT=90d

### Порт сервиса из docker (проксирование на LISTEN_HTTP_PORT в докере). Используется только при запуске в докер контейнере.
PUBLIC_HTTP_PORT=7777

### Сохранять сваггер файл при запуске в папке swagger
SAVE_SWAGGER=1

### Разрешить пользователям самим регистрироваться
#### В этом режиме разрешен ендпоинт register, позволяющий пользователям самим регистрироваться в системе, с низшей ролью и включеной блокировкой
ALLOW_USER_REGISTRATION=0

### Запрещать получение списка пользователей всем группам кроме админа
DENY_GET_USER_LIST=0

### Админ не может изменять пароль другого админа, блокировать и удалять любого админа
DENY_ADMIN_CHANGE_ADMIN=0

## Защита от brute force атак
### Задержка в ms, в случае неудачи логина
BRUTE_FORCE_LOGIN_DELAY = 2000

### Интервал в ms, окно разрешенного кол. запросов на маршрут login
BRUTE_FORCE_LOGIN_TTL = 10000
### Разрешенное кол. запросов за интервал BRUTE_FORCE_LOGIN_TTL
BRUTE_FORCE_LOGIN_LIMIT = 10

### Интервал в ms, окно разрешенного кол. запросов на маршрут whoami
BRUTE_FORCE_WHOAMI_TTL = 60000
### Разрешенное кол. запросов за интервал BRUTE_FORCE_WHOAMI_TTL
BRUTE_FORCE_WHOAMI_LIMIT = 100000

### Интервал в ms, окно разрешенного кол. запросов на любые маршруты по умолчанию
BRUTE_FORCE_DEFAULT_TTL = 20000
### Разрешенное кол. запросов за интервал BRUTE_FORCE_DEFAULT_TTL
BRUTE_FORCE_DEFAULT_LIMIT = 10000
